language: ruby

services:
  - docker

before_install:
  - docker -v
  - docker-compose -v

install:
  - envsubst < ./config/application.sample.yml > ./config/application.yml
  - docker-compose build

before_script:
  - docker-compose run --rm --no-deps web echo 'Gems now pre-installed.'
  - # Use 'run ...` instead of 'exec ...` so that entrypoint's customized bundle install runs completely.
  - docker-compose -f docker-compose.yml up -d
  - # The detached `up` also runs entrypoint â€” but because it's detached,
  - # bundle install doesn't finish before shell moves on to next commands.
  - docker ps
  - docker-compose run -e "RAILS_ENV=test" web rake db:migrate

script:
  - docker-compose run web rspec spec

deploy:
  provider: heroku
  api_key:
    secure: <%= ENV['HEROKU_API_KEY'] %>
  app: thee-blogger-app
  on:
    repo: IncredibleBlackMan/Blogger
